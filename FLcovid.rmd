---
title: "FloridaCovid"
author: "Hugh Whelan"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r echo=FALSE, include=FALSE}
library(readr)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(reshape2)
library(scales)
library(stringi)
library(lubridate)
library(urbnmapr)
library(tidyverse)
library(maps)
library(viridis)
library(DT)
library(zoo)
library(downloader)
library(kableExtra)
library(knitr)
library(formattable)
library(socviz)
library(imager)
library(MASS)
library(Hmisc)
library(smoother)
library(HDInterval)
library(ggExtra)
library(xlsx)
library(gsheet)
library(tidyverse)
library(summarytools)

# FL cause of death data
# http://www.flhealthcharts.com/FLQUERY/Death/DeathCount.aspx



# CDC underlying cause of death data

url2 <- "https://data.cdc.gov/resource/muzy-jte6.csv"
causeDeath <- data.table(read.csv(url(url2)))
causeDeath<-causeDeath[jurisdiction_of_occurrence=="Florida",]
causeMaxWeek<-causeDeath[mmwryear==2020,max(mmwrweek)]
causeDeath[is.na(causeDeath)] <- 0

cause<-data.frame(t(causeDeath[mmwrweek<=causeMaxWeek, lapply(.SD, sum), by = mmwryear, .SDcols=5:19]))
cause$chg<-cause$X2-cause$X1
cause$chgPct=cause$X2/cause$X1-1
cause<-cause[2:nrow(cause),]
colnames(cause)<-c("2019 partial","2020 partial","Difference","Pct Change")

# cdc place of death data

url2<-"https://data.cdc.gov/resource/uggs-hy5q.csv"
placeDeath<-data.table(read.csv(url(url2)))
placeDeath<-placeDeath[state=="United States" | state=="Florida",]
placeDeath[is.na(placeDeath)] <- 0
placeDeath[,pctCovid:=covid19_deaths/sum(covid19_deaths),by=state]
placeDeath[,pctPIcovid:=pneumonia_influenza_or_covid19/sum(pneumonia_influenza_or_covid19),by=state]

placeCht1<-ggplot(placeDeath, aes(x=place_of_death, y=pctCovid, fill=state)) +
    geom_bar(stat='identity', position='dodge') +
   theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust=1)) +
     scale_y_continuous(labels=scales::percent) +
  labs(y="% of Covid Deaths",
       x="Place of Death",
       title="Florida: Place of Death For Covid Deaths",
       subtitle = "https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-by-Place-of-Deat/uggs-hy5q")

placeCht2<-ggplot(placeDeath, aes(x=place_of_death, y=pctPIcovid, fill=state)) +
    geom_bar(stat='identity', position='dodge') +
   theme(axis.text.x = element_text(angle = 50, vjust = 1, hjust=1)) +
     scale_y_continuous(labels=scales::percent) +
  labs(y="% of P, I & Covid Deaths",
       x="Place of Death",
       title="Florida: Place of Death For Pneumonia, Influenza or Covid",
       subtitle = "https://data.cdc.gov/NCHS/Provisional-COVID-19-Death-Counts-by-Place-of-Deat/uggs-hy5q")


# Google mobility data
urlfile="https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv"
goog<-data.table(read_csv(url(urlfile),col_types = list(col_character(),col_character(),col_character(),col_character(),
                                                        col_character(),col_character(),
                                                        col_date(),col_integer(),col_integer(),col_integer(),
                                                        col_integer(),col_integer(),col_integer(),col_integer())))

goog[,state:=as.factor(sub_region_1)]
stGoog<-goog[is.na(sub_region_2),]

stGoog<-stGoog[state=="Florida" | state=="New York" | state=="California",]
stGoog<-stGoog[order(sub_region_1,date),]

g1<-ggplot(stGoog, aes(x=date, y=retail_and_recreation_percent_change_from_baseline, group=state,color=state)) +
  scale_shape_manual(values=1:nlevels(stGoog$state)) +
  # geom_line()+
  geom_point() +
  theme_bw()  +
  labs(y="Retail/Recreation Decline From Baseline",
       x="Date",
       title="Google Mobility Data",
       subtitle="Data: https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

stGoog[,sevDayWork:=rollmean(workplaces_percent_change_from_baseline,7,align="right",na.pad = T),by=state]
stGoog[,sevDayHome:=rollmean(residential_percent_change_from_baseline,7,align="right",na.pad = T),by=state]

g2<-ggplot(stGoog[date>"2020-03-05",], aes(x=date, y=sevDayWork, group=state,color=state)) +
  scale_shape_manual(values=1:nlevels(stGoog$state)) +
  # geom_line()+
  geom_point() +
  theme_bw()  +
  labs(y="Workplaces Decline From Baseline",
       x="Date",
       title="Google Mobility Data: 7-Day Rolling Mean",
       subtitle="Data: https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

g3<-ggplot(stGoog, aes(x=date, y=residential_percent_change_from_baseline, group=state,color=state)) +
  scale_shape_manual(values=1:nlevels(stGoog$state)) +
  geom_line()+
  geom_point() +
  theme_bw()  +
  labs(y="Residential Change From Baseline",
       x="Date",
       title="Google Mobility Data: 7-Day Rolling Mean",
       subtitle="Data: https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")


# flu data https://gis.cdc.gov/grasp/fluview/mortality.html

# The population of Florida in 2019 was 21,477,737, a 1.1% increase from 2018. The population of Florida in 2018 was 21,244,317, a 1.34% increase from # 2017. The population of Florida in 2017 was 20,963,613, a 1.7% increase from 2016. The population of Florida in 2016 was 20,613,477, a 2% increase # from 2015.
multply<-c(1.011*1.0134*1.017*1.02,1.011*1.0134*1.017,1.011*1.0134,1.011,1)
fluDat<-data.table(read.csv("C://Users/whelanh/Dropbox/covid/State_Florida_2015-20_Data.csv"))
fluDat[,totDeath:=as.numeric(gsub(",","",TOTAL.DEATHS))]
fluDat[SEASON=="2015-16",adjDeath:=multply[1]*totDeath]
fluDat[SEASON=="2016-17",adjDeath:=multply[2]*totDeath]
fluDat[SEASON=="2017-18",adjDeath:=multply[3]*totDeath]
fluDat[SEASON=="2018-19",adjDeath:=multply[4]*totDeath]
fluDat[SEASON=="2019-20",adjDeath:=totDeath]
fluDat[,season:=paste0(substr(SEASON,1,2),substr(SEASON,6,7))]

# need to change this manually to 2 on Friday, back to 3 when week advances 1
lastWkNum<-week(Sys.Date())-3

deets<-fluDat[WEEK<lastWkNum,.(sum(totDeath),sum(adjDeath)),by=SEASON]

excessDeaths<-max(deets$V2)-mean(deets$V2[1:4])


allDthPlot<-ggplot(data=fluDat[WEEK<lastWkNum,],aes(x=WEEK,y=adjDeath,group=season,colour=season)) +
  geom_line() +
    labs(y = "Weekly All Deaths",
                 x = "Week Number",
                 colour = "Florida",
                 title = "FLorida: Deaths From All Causes vs. Population-Adjusted Prior Years",
         subtitle = paste("Through Week", lastWkNum," Data: https://gis.cdc.gov/grasp/fluview/mortality.html"))  


# long term care data from @kerpen and @nosmhnmh
ltcDat<-data.table(gsheet2tbl("https://docs.google.com/spreadsheets/d/1ETm51GayRjlnoaRVtUOWfkolEeAQZ-zPhXkCbVe4_ik/edit#gid=1417804764"))

ltcDat2<-ltcDat[3:nrow(ltcDat),1:9]
colnames(ltcDat2)<-as.character(ltcDat[2,1:9])
ltcDat2[,date:=as.Date(paste0(ltcDat2$X1,"-2020"),"%d-%b-%Y")]
ltcDat2<-ltcDat2[!is.na(date)]
ltcDat2[,ltc:=as.numeric(gsub(",", "", LTC))]
ltcDat2[,tot:=as.numeric(gsub(",", "", Total))]
ltcDat2[,ltcDaily:=ltc-lag(ltc,1)]
ltcDat2[,totDaily:=tot-lag(tot,1)]
ltcDat2[,pctLtcDaily:=ltcDaily/totDaily]
ltcDat2[,pctLtcCum:=ltc/tot]

cumLTCdeath<-ltcDat2[date==max(date),pctLtcCum]

ltc<- ggplot(ltcDat2) + 
  geom_col(aes(x = date, y = ltcDaily), size = 1, color = "white", fill = "darkblue",group=1) +
  geom_line(aes(x = date, y = rollmean(ltcDaily,7,align = "right",na.pad = T)), size = 1.5, color="green", group = 2) + 
  geom_line(aes(x = date, y = 100*pctLtcDaily), size = 1, color="red", group = 3) + 
  scale_y_continuous(sec.axis = sec_axis(~.,name = "% of Daily Total Covid Deaths")) +
  scale_colour_manual(values = c("blue", "red","green")) +
    labs(y = "Daily Deaths",
                 x = "Date",
                 colour = "Florida",
                 title = "Daily Long Term Care Covid Deaths (Blue bars and green 7 day average - left axis)",
         subtitle = "Red line = Daily LTC Covid death share of Daily Covid deaths - right axis")  
 
url<-"https://data.cdc.gov/api/views/r8kw-7aab/rows.csv?accessType=DOWNLOAD"
cdcDat<-data.table(read.csv(url))

cdcDat<-cdcDat[State=="Florida",]

cdcDat[,pctCov:=COVID.19.Deaths/Total.Deaths]
cdcDat[,endDate:=as.Date(End.Week,"%m/%d/%Y")]
cdcDat<-cdcDat[!is.na(pctCov),]
cdcDat[,PneumInfluez:=Influenza.Deaths+(Pneumonia.Deaths - Pneumonia.and.COVID.19.Deaths)]

ny3<- ggplot(cdcDat, aes(x = endDate, y = pctCov)) + geom_line(color="darkblue") + geom_point(color="red") +
    scale_y_continuous(labels=scales::percent) +
  labs(y="Weekly Covid Deaths/Weekly All Deaths %",
       x="Date",
       title="Weekly Covid Deaths As A Percent of Weekly Total FL Deaths",
       subtitle = "Data:https://data.cdc.gov/api/views/r8kw-7aab/rows.csv?accessType=DOWNLOAD")

lastCDCpct<-cdcDat[endDate==max(endDate),pctCov]

#nyt death by county
url <-
  "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
nyt <-   data.table(read_csv(url(url), skip = 0))
nyt[, date := as.Date(date)]
nytf <- nyt[state == "Florida", ]


# flDat[,cumDeath:=cumsum(death)]
  
# Section to look at All Casuses Deaths in 2020 vs 2018/2019 Population Adjusted Baseline and 2020 Covid Deaths  

fl2018dBym <-
  data.table(
    read.xlsx(
      "C://Users/whelanh/Dropbox/covid/FL2018byMonth.xlsx",
      sheetName = "Sheet1",
      startRow = 3,
      header = F
    )
  )
fl2019dBym <-
  data.table(
    read.xlsx(
      "C://Users/whelanh/Dropbox/covid/FL2019byMonth.xlsx",
      sheetName = "Sheet1",
      startRow = 3,
      header = F
    )
  )
fl2020dBym <-
  data.table(
    read.xlsx(
      "C://Users/whelanh/Dropbox/covid/FL2020byMonth.xlsx",
      sheetName = "Sheet1",
      startRow = 3,
      header = F
    )
  )

tTable <- function(x) {
  an <- t(x[2:nrow(x), 3:14])
  nms <- as.vector(x[2:nrow(x), 1])
  colnames(an) <- nms$X1
  an
}

f2019 <- tTable(fl2019dBym)
f2020 <- tTable(fl2020dBym)
f2018 <- tTable(fl2018dBym)

# Include another month
MonToInclude <- 6   #### CHANGE HERE EVERY MONTH

# Adust deaths for population growth to compare to 2020
grAdjBase <- (f2018 * 1.012 ^ 2 + f2019 * 1.012) / 2
delt2020 <- f2020 - grAdjBase
marMaysum <- data.frame(colSums(delt2020[3:MonToInclude, ]))
marMaysum$county <- tolower(rownames(marMaysum))

grAdjBaseSum<-data.frame(colSums(grAdjBase[3:MonToInclude, ]))
grAdjBaseSum$county<-tolower(rownames(grAdjBaseSum))

f2020BaseSum<-data.frame(colSums(f2020[3:MonToInclude, ]))
f2020BaseSum$county<-tolower(rownames(f2020BaseSum))

nytMay <- data.frame(nytf[date == "2020-06-30", ])  #### CHANGE HERE EVERY MONTH
nytMay$county <- tolower(nytMay$county)

compTab<-merge(grAdjBaseSum,f2020BaseSum,by="county")
compTab<-merge(compTab,marMaysum,by="county")
compTab <- merge(compTab, nytMay, by = "county")
ansTab <- compTab[, c(1:4, 9)]
colnames(ansTab) <- c("county","2019-18adjBase","2020AllDeaths", "2020vs2018-19Delta", "Covid Deaths")
ansTab$`2019-18adjBase` <- round(ansTab$`2019-18adjBase`,0)
ansTab$`2020vs2018-19Delta` <- round(ansTab$`2020vs2018-19Delta`, 0)
ansTab$nonCovidDelta <-
  ansTab$`2020vs2018-19Delta` - ansTab$`Covid Deaths`
ansTab <- rbind(c("TOTAL", colSums(ansTab[2:6])),ansTab)


# Section to look at age composition of deaths in All Causes 2019 & 2020 and 2020-Covid

fl2019dByAge <-
  data.table(
    read.xlsx(
      "C://Users/whelanh/Dropbox/covid/FL2019byAge.xlsx",
      sheetName = "Sheet1",
      startRow = 3,
      header = F
    )
  )

colnames(fl2019dByAge)<-c("Region","Total","0-<1","1-4","5-9","10-14","15-19","20-24","25-34","35-44","45-54","55-64","65-74","75-84","85+","Unk")

fl2020dByAge <-
  data.table(
    read.xlsx(
      "C://Users/whelanh/Dropbox/covid/FL2020byAge.xlsx",
      sheetName = "Sheet1",
      startRow = 3,
      header = F
    )
  )

labvec<-c("Region","Total","0-<1","1-4","5-9","10-14","15-19","20-24","25-34","35-44","45-54","55-64","65-74","75-84","85+","Unk")
colnames(fl2020dByAge)<-labvec

fbyA19<-data.table(t(fl2019dByAge[Region=="FLORIDA",3:15]))
fbyA19[,pctTot:=V1/sum(V1)]
fbyA19[,year:="2019AllDeaths"]
fbyA19[,Age:=labvec[3:15]]
fbyA19<-fbyA19[,c("Age","year","pctTot")]

fbyA20<-data.table(t(fl2020dByAge[Region=="FLORIDA",3:15]))
fbyA20[,pctTot:=V1/sum(V1)]
fbyA20[,year:="2020AllDeathsYTD"]
fbyA20[,Age:=labvec[3:15]]
fbyA20<-fbyA20[,c("Age","year","pctTot")]



# JHCounty data upates after 8 pm Eastern Time
if (hour(Sys.time()) > 21) {
  dt <- Sys.Date()
} else {
  dt <- Sys.Date() - 1
}

dt<-Sys.Date()-1

yest <- paste0(month(dt), "-", day(dt), "-", year(dt))
# John Hopkins Daily Reports at County Level
urlfile = paste0(
  "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/",
  format(as.Date(yest, format = "%m-%d-%y"), "%m-%d-%Y"),
  ".csv"
)
JHcounty <- data.table(read_csv(url(urlfile)))

# CDC model forecasts for FL
url2<-"https://www.cdc.gov/coronavirus/2019-ncov/covid-data/files/2020-06-29-model-data.csv"
 cdcForecast<-data.table(read_csv(url(url2)))
 cdcForecast<-cdcForecast[location_name=="Florida" & target_week_end_date==max(target_week_end_date),]
 cdcForecast<-cdcForecast[order(point),]
 cdcForc<-cdcForecast[,c(1,2,4,6:8)]
 # write.csv(cdcForc,file="CDCforecast.csv")

# REad in FL DOH data
url2 = "https://opendata.arcgis.com/datasets/37abda537d17458bae6677b8ab75fcb9_0.csv"
flDat<- data.table(read_csv(url(url2), skip = 0))
flDat[, eDat := as.Date(EventDate)]
flDat[, cDat := as.Date(Case1)]
flDat[, chtDat := as.Date(ChartDate)]

flDat[Hospitalized=="YES",hosp:=1]
flDat[is.na(hosp),hosp:=0]
flDat[Hospitalized=="YES" & EDvisit=="YES",hospED:=1]
flDat[is.na(hospED),hospED:=0]
flDat[EDvisit=="YES",edvisitor:=1]
flDat[is.na(edvisitor),edvisitor:=0]
flDat[EDvisit=="YES" & Hospitalized != "YES",edNoHosp:=1]
flDat[is.na(edNoHosp),edNoHosp:=0]

hospShare<-flDat[,.(sum(hosp),sum(hospED),sum(edvisitor),sum(edNoHosp)),by=eDat]
hospShare[,pctED:=V2/V1]
hospShare[,EDpctNotHosp:=V4/V3]
hospShare<-hospShare[eDat>"2020-03-15",]

edHospShare<- ggplot(hospShare) + 
  geom_line(aes(x = eDat, y = pctED, color="steelblue")) + 
   scale_y_continuous(labels=scales::percent, limits=c(0,1)) +
  theme(legend.position = "none") +
    labs(y = "% Hospitalizations Also Coded For ED Visit",
                 x = "Event Date",
                 colour = "Florida",
                 title = "Florida: % of Hospitalizations Also Coded EDvisit = 'YES'") 

edHospShare2<- ggplot(hospShare) + 
  geom_line(aes(x = eDat, y = EDpctNotHosp, color="steelblue")) + 
   scale_y_continuous(labels=scales::percent, limits=c(0,1)) +
  theme(legend.position = "none") +
    labs(y = "% EDvist='YES' But Hospitalization != 'YES'",
                 x = "Event Date",
                 colour = "Florida",
                 title = "Florida: % of All ED visits NOT Coded Hospitalization = 'YES'")  


# Section for when DOH site not working and get from https://covid19-usflibrary.hub.arcgis.com/search?owner=USFDHHC.GIS
# url2<-"C:\\Users/whelanh/Downloads/Florida_COVID19_06242020_Case_Line_Data.csv"
# flDat<- data.table(read_csv(url2, skip = 0))
# flDat[, eDat := as.Date(EventDate,"%m/%d/%Y")]
# flDat[, cDat := as.Date(Case_,"%m/%d/%Y")]
#------------------------------------------------------------------------------------------------------------------------

flDat[, medAge := median(Age, na.rm = T), by = eDat]
flDat <- flDat[order(eDat), ]
a <- flDat[, .N, by = eDat]
a <- a[order(eDat), ]


a <- flDat[, .N, by = eDat]
a <- a[order(eDat), ]

flDat[Age<30,ageCat:="29 or less"]
flDat[Age>=30 & Age<50,ageCat:="30-49"]
flDat[Age>=50 & Age < 65,ageCat:="50-64"]
flDat[Age>=65 & Age < 75, ageCat:="65-74"]
flDat[Age>=75 & Age < 85, ageCat:="75-84"]
flDat[Age>=85, ageCat:="85 or more"]

flDat[Hospitalized=="YES",hosCat:="Hospitalized"]
flDat[Hospitalized!="YES" & EDvisit=="YES",hosCat:="ED Only"]
flDat[is.na(hosCat),hosCat:="Other"]
flDat[Hospitalized=="YES",hospice:=1]
flDat[is.na(hospice),hospice:=0]

cDeathbyAge<-flDat[Died=="Yes",.N, by=Age_group]
cDeathbyAge[,pctTot:=N/sum(N)]


allCcomb<-data.table(rbind(fbyA19,fbyA20))
allCcomb[Age=="1-4",Age:="01-4"]
allCcomb[Age=="5-9",Age:="05-9"]

allCcht<-ggplot(allCcomb, aes(fill=year, y=pctTot, x=Age)) + 
    geom_bar(position="dodge", stat="identity")

allCcomb[Age=="0-<1" | Age=="01-4" ,Age_group:="0-4 years"]
allCcomb[Age=="05-9" | Age=="10-14",Age_group:="5-14 years"]
allCcomb[Age=="15-19" | Age=="20-24",Age_group:="15-24 years"]
allCcomb[Age=="25-34",Age_group:="25-34 years"]
allCcomb[Age=="35-44",Age_group:="35-44 years"]
allCcomb[Age=="45-54",Age_group:="45-54 years"]
allCcomb[Age=="55-64",Age_group:="55-64 years"]
allCcomb[Age=="65-74",Age_group:="65-74 years"]
allCcomb[Age=="75-84",Age_group:="75-84 years"]
allCcomb[Age=="85+",Age_group:="85+ years"]

newTab<-allCcomb[,sum(pctTot),by=c("year","Age_group")]
cDeathbyAge[,year:="CovidDeaths2020"]
colnames(newTab)<-c("year","Age_group","pctTot")
newTab2<-rbind(newTab,cDeathbyAge[,c("year","Age_group","pctTot")])
newTab2[Age_group=="5-14 years",Age_group:="05-14 years"]

allCcht2<-ggplot(newTab2, aes(fill=year, y=pctTot, x=Age_group)) + 
    geom_bar(position="dodge", stat="identity") +
     scale_y_continuous(labels=scales::percent) +
  labs(  y = "% of All Deaths",
  x = "Age Group",
  colour = "Florida",
  title = "FL Distribution of All Deaths and Covid Deaths",
  subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data"
)



# re-look at lags
  
 flDat[Died=="Yes",death:=1]
 flDat[is.na(death),death:=0]
 ageTab<-flDat[Died=="Yes",sum(death),by=c("Age")]
 # ageTab<-flDat[Died=="Yes",sum(death),by=c("Age","cDat")]
 # rolAge<-ageTab[,wtd.quantile(Age,weights=V1,0.1),by=cDat]
 
 
 ageTab<-ageTab[order(-Age),]
 ageTab[,cumPct:=cumsum(V1)/sum(V1)]
 ageCutoff<-wtd.quantile(ageTab[,Age],weights = ageTab[,V1],0.1)
 
 dailyRelCases<-flDat[Age>ageCutoff,.N,by=cDat]
 dailyDeaths<-flDat[,sum(death),by=cDat]
 newLagTab<-merge(dailyDeaths,dailyRelCases,by="cDat", all.x=T)
 newLagTab[is.na(N),N:=0]
 newLagTab[,d7Case:=rollmean(N,7,align="right",na.pad = T)]
 newLagTab[,d7Death:=rollmean(V1,7,align="right",na.pad = T)]
 
 Samp<-newLagTab[cDat>"2020-03-15",]
 Samp<-Samp[order(cDat),]

 ansMatNew<-data.table()

for (i in 30:nrow(Samp)) {
  ccfObj<-ccf(Samp[(i-29):i,d7Case],Samp[(i-29):i,d7Death],30)
  m<-data.table(cbind(ccfObj$acf,ccfObj$lag))
  m<-cbind(m[V2<=0,],rep(Samp[i,cDat],30))
  ansMatNew<-rbind(ansMatNew,m)
}

 colnames(ansMatNew)<-c("acf","lag","Date")
 ansMatNew[,date:=as.factor(format(Date,"%m-%d"))]
 ansMM2New<-ansMatNew[Date>Sys.Date()-40,mean(acf),by=lag]
 bestLagNew<-ansMM2New[V1==max(V1),lag]*-1

 
 # Section to look at lags between reported daily cases and future daily deaths
# lagDat<-nyt[state=="Florida",.(sum(cases),sum(deaths)),by=date]
# lagDat[,dCase:=V1-lag(V1,1)]
# lagDat[,dDeath:=V2-lag(V2,1)]
# lagDat[,d7Case:=rollmean(dCase,7,align="right",na.pad = T)]
# lagDat[,d7Death:=rollmean(dDeath,7,align="right",na.pad = T)]

 dailyRelCases2<-flDat[Age>0,.N,by=cDat]
 lagDat<-merge(dailyDeaths,dailyRelCases2,by="cDat", all.x=T)
 lagDat[is.na(N),N:=0]
 lagDat[,d7Case:=rollmean(N,7,align="right",na.pad = T)]
 lagDat[,d7Death:=rollmean(V1,7,align="right",na.pad = T)]
 
 Samp<-lagDat[cDat>"2020-03-15",]
 Samp<-Samp[order(cDat),]

 ansMat<-data.table()

for (i in 30:nrow(Samp)) {
  ccfObj<-ccf(Samp[(i-29):i,d7Case],Samp[(i-29):i,d7Death],30)
  m<-data.table(cbind(ccfObj$acf,ccfObj$lag))
  m<-cbind(m[V2<=0,],rep(Samp[i,cDat],30))
  ansMat<-rbind(ansMat,m)
}

 colnames(ansMat)<-c("acf","lag","Date")
 ansMat[,date:=as.factor(format(Date,"%m-%d"))]
 ansMM2<-ansMat[Date>Sys.Date()-40,mean(acf),by=lag]
 bestLag<-ansMM2[V1==max(V1),lag]*-1

ansMM2<-cbind(ansMM2,ansMM2New)
colnames(ansMM2)<-c("lag","V1","lag2","V1rel")

 l3<-ggplot(data=ansMM2,aes(x=lag)) +
   geom_line(aes(y=V1),color="darkred") +
   geom_line(aes(y=V1rel),color="steelblue", linetype="twodash") +
   # theme_bw()  +
   labs(y="Correlation",
        x="Lag (Days)",
        title="FL: Mean 30 Day Cross-Correlation Between 7 Day Avgeraged Daily Deaths and Cases",
        subtitle=paste("30 Day Periods Ending From ",Sys.Date()-40,"to now. Data: FL DOH")) +
    geom_text(x=-20, y=-0.2, label="Red = All Cases",color="darkred") +
   geom_text(x=-17, y=-0.25, label=paste0("Blue = Cases Older Than Age ",ageCutoff," that generate 90% Of Deaths"),color="steelblue")


 Samp<-merge(Samp,dailyRelCases,by="cDat")
 Samp[,d7CaseRel:=rollmean(N.y,7,align = "right",na.pad = T)]

 Samp2<-Samp[cDat>Sys.Date()-100,]

  lagz <- ggplot(Samp2, aes(x = cDat))
 # lagz <- lagz + geom_line(aes(x=cDat+bestLag, y= d7Case, colour = paste("7-Day Avg Daily Cases Fwd ",bestLag)))
 lagz <- lagz + geom_line(aes(x=cDat+bestLagNew, y= d7CaseRel, colour = paste("7-Day Avg Cases Older Than",ageCutoff," Fwd ",bestLagNew,"(left)")))
 #  lagz <- lagz + geom_line(aes(x=cDat, y= (d7Case), colour = paste("7-Day Avg Daily All Cases"))) 
 # lagz <- lagz + geom_line(aes(x=cDat, y= (d7CaseRel), colour = paste("7-Day Avg Cases Age Older Than ",ageCutoff))) 
#   # adding the relative humidity data, transformed to match roughly the range of the temperature
  lagz <- lagz + geom_line(aes(x=cDat, y = d7Death*20, colour = "7 Day Avg. Daily Deaths (right)"))
  # lagz<- lagz + geom_vline(xintercept = as.Date("2020-06-01"), linetype="dashed", 
                # color = "black", size=1.1)
# 
#   # now adding the secondary axis, following the example in the help file ?scale_y_continuous
#   # and, very important, reverting the above transformation
   lagz <- lagz + scale_y_continuous(sec.axis = sec_axis(~./20, name = "7 Day Avg. Daily Deaths"))
# 
#   # modifying colours and theme options
  lagz <- lagz + scale_colour_manual(values = c("blue", "red", "black"))
 lagz <- lagz + labs(y = "7 Day Avg.New Cases",
                 x = "Case Date",
                 colour = "Florida",
                  title = "Covid Deaths vs. Cases Older than 59 That Generate 90% of Covid Deaths")
                 # title = "Cases Projected Forward Based On Strongest Cross-Correlation")
  lagz <- lagz + theme(legend.position = c(0.7, 0.9))

# Look at CFRs detrended by testing volume
  flDat[,mn:=month(eDat)]
  # flDat[,cs:=1]
  flDat[Age_group=="5-14 years",Age_group:="05-14 years"]
  
  #CFR
  ttt1<-flDat[,sum(death)/.N,by=c("mn","Age_group")]
  
  ttt1[,V1:=percent(V1,digits = 1)]
  ttt2<-spread(ttt1,mn,V1)
  
  # hospitalization rate
  ttt3<-flDat[,sum(hospice)/.N,by=c("mn","Age_group")]
  ttt3[,V1:=percent(V1,digits = 1)]
  ttt3<-spread(ttt3,mn,V1)
  
  # hosp death rate
  ttt4<-flDat[,sum(death)/sum(hospice),by=c("mn","Age_group")]
  ttt4[,V1:=percent(V1,digits = 1)]
  ttt4<-spread(ttt4,mn,V1)
  
  
  
  # tttlag1<-flDat[,sum(lag(cs,14),na.rm = T),by=c("eDat","Age_group")]
  # tttlag2<-flDat[,sum(death),by=c("eDat","Age_group")]
  # tttlag2<-merge(tttlag2,tttlag1,by=c("eDat","Age_group"))
  # tttlag2[,mn:=month(eDat)]
  # tttlag3<-tttlag2[,sum(V1.x)/sum(V1.y),by=c("mn","Age_group")]
  # tttlag3[,V1:=percent(V1)]
  # tttlag4<-spread(tttlag3,mn,V1)

  tttd<-flDat[,sum(death),by="mn"]
  tttc<-flDat[,.N,by="mn"]
  tttc<-merge(tttd,tttc,by="mn")
  colnames(tttc)<-c("Month","Deaths","Cases")
  tttc[,Deaths:=comma(Deaths,digits = 0)]
  tttc[,Cases:=comma(Cases,digits = 0)]
  
  urlfile<- "https://covidtracking.com/api/v1/states/daily.csv"
  stLevel<-data.table(read.csv(url(urlfile)))
  stLevel<-stLevel[state=="FL",]
  stLevel[,Date:=as.Date(as.character(date),format="%Y%m%d")]
  stLevel[,mn:=month(Date)]
  stLevel<-stLevel[order(Date),]
 
   test3<-ggplot(data=stLevel,aes(x=Date)) +
   geom_line(aes(y=totalTestResultsIncrease),color="steelblue") +
   geom_line(aes(x=Date,y=rollmean(totalTestResultsIncrease,7,align = "right",na.pad = T)),color="darkred", linetype="twodash") +
   # theme_bw()  +
   labs(y="Total Tests",
        x="Date",
        title="Florida Covid Testing By Day",
        subtitle=paste("Red Line is 7-Day Rolling Average")) 

  
 #  tests<-stLevel[,sum(totalTestResultsIncrease),by=mn]
 #  ttt3<-stLevel[,sum(deathIncrease,na.rm = T)/sum(lag(positiveIncrease,14),na.rm = T),by=c("mn")]
 #  
 #  lmModDat<-stLevel[mn>4,]
 #  lmModDat<-lmModDat[order(Date),]
 #  testMod<-(lm(lmModDat$positiveIncrease~lmModDat$totalTestResultsIncrease))
 #  
 # plot(stLevel$Date,stLevel$deathIncrease)
 
# section lookin at linear decline in cum death growth rate.
test<-flDat[,sum(death),by=eDat]
test[,deltaDeath:=V1/lag(V1,1)]
test[,cumDeath:=cumsum(V1)]
test[,deltaCumDeath:=cumDeath/lag(cumDeath,1)]
test[,sevDcum:=rollmean(cumDeath,7,align = "right",na.pad = T)]
test[,delt7DayCum:=sevDcum/lag(sevDcum,1)]
test[,lglgD7:=log(log(delt7DayCum))]

subtest<-test[eDat>"2020-03-15" & eDat < Sys.Date()-7,]
lglgMod<-lm(data=subtest,lglgD7 ~ eDat)

test[,pred:=predict(lglgMod,newdata = test)]
test[,predDelt:=exp(exp(pred))]
test[,fit7dayCum:=predDelt*lag(sevDcum,1)]

linearDF<-data.frame(seq(Sys.Date()-4,Sys.Date()+120,by=1))
colnames(linearDF)<-c("eDat")
linearDF$pred<-predict(lglgMod,newdata = linearDF)
linearDF$delt<-exp(exp(linearDF$pred))
linearDF$fwd7cumDeath<-test[eDat==Sys.Date()-4,sevDcum]*cumprod(linearDF$delt)
additionalDeaths<-max(linearDF$fwd7cumDeath)-max(test$sevDcum,na.rm = T)

mlevitt<- ggplot(test[eDat>"2020-03-15"]) + 
  geom_point(aes(x = eDat, y = lglgD7, color="log(log(d(7-Day Avg. Cum. Death/dt)))")) + 
  geom_line(aes(x = eDat, y = pred, color="Predicted")) + 
 scale_colour_manual(values = c("steelblue", "darkred")) +
    labs(y = "log(log(7-Day Avg. Cum Death/dt)))",
                 x = "Event Date",
                 colour = "Florida",
                 title = "Florida: Plot of log(log(growth rate of cumulative Covid deaths))") +
   theme(legend.position = c(as.numeric(test[eDat=="2020-04-01",eDat]), -6))


  

  
# Look at characteristics of hospitalization

xx <-
  flDat[EDvisit == "YES" &
          Hospitalized != "YES" &
          eDat >= "2020-02-29" , .N, by = c("eDat", "ageCat")]

xx<-xx[order(eDat,ageCat),]

xxcht<- ggplot(xx, aes(x = eDat, y = N))+
  geom_col(aes(fill = ageCat), width = 0.7) +
  scale_color_gradientn(colours = rainbow(6)) +
  labs(  y = "ED Visit = YES but Hospitalized = NO",
  x = "Event Date",
  colour = "Florida",
  title = "ED Visit, but not Hospitalized"
)

xxx <-
  flDat[Hospitalized == "YES" &
          eDat >= "2020-02-29" , .N, by = c("eDat", "ageCat")]

xxx<-xxx[order(eDat,ageCat),]

xxxcht<- ggplot(xxx, aes(x = eDat, y = N))+
  geom_col(aes(fill = ageCat), width = 0.7) +
  scale_color_gradientn(colours = rainbow(6)) +
  labs(  y = "Hospitalized = YES",
  x = "Event Date",
  colour = "Florida",
  title = "Age Grouping Of Those Hospitalized w/Covid"
)

# Look at characteristics of Covid Death by Age

dd <-
  flDat[Died == "Yes" &
          eDat >= "2020-02-29" , .N, by = c("eDat", "ageCat")]

dd<-dd[order(eDat,ageCat),]
dd2<-dd[ageCat=="85 or more" | ageCat=="75-84" | ageCat=="65-74",sum(N),by=eDat]
dd3<-dd[,sum(N),by=eDat]
dd2<-merge(dd2,dd3,by="eDat")
dd2[,pctGE65:=V1.x/V1.y]
dd2[,Roll7pctGE65:=rollmean(pctGE65,7,align = "right",na.pad = T)]

dd<-merge(dd,dd2,by="eDat")

ddcht<- ggplot(dd, aes(x = eDat, y = N))+
  geom_col(aes(fill = ageCat), width = 0.7) +
  scale_color_gradientn(colours = rainbow(6)) +
  labs(  y = "Died = Yes",
  x = "Event Date",
  colour = "Florida",
  title = "Age Grouping Of Covid Deaths",
  subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data"
)

ddcht2 <- ggplot(dd,aes(x=eDat,y=Roll7pctGE65)) + geom_line() +
   scale_y_continuous(labels=scales::percent, limits = c(0,1)) +
  labs(  y = "7 Day Mean % All Deaths",
  x = "Event Date",
  title = "% of Covid Deaths From Those Aged 65 and Older",
  subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data"
)


ddd <-
  flDat[Died == "Yes" &
          eDat >= "2020-02-29" , .N, by = c("eDat", "hosCat")]

dddcht<- ggplot(ddd, aes(x = eDat, y = N))+
  geom_col(aes(fill = hosCat), width = 0.7) +
  scale_color_gradientn(colours = rainbow(6)) +
  labs(  y = "Died",
  x = "Event Date",
  colour = "Florida",
  title = "Deaths By Hospitalization Status",
    subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data"
)

ddd2<-ddd[hosCat=="Hospitalized",sum(N),by=eDat]
ddd3<-ddd[,sum(N),by=eDat]
ddd2<-merge(ddd2,ddd3,by="eDat")
ddd2[,pctHospitalized:=V1.x/V1.y]
ddd2[,Roll7pctHospitalized:=rollmean(pctHospitalized,7,align = "right",na.pad = T)]

ddd<-merge(ddd,ddd2,by="eDat")

dddcht2 <- ggplot(ddd,aes(x=eDat,y=Roll7pctHospitalized)) + geom_line() +
   scale_y_continuous(labels=scales::percent, limits = c(0,1)) +
  labs(  y = "7 Day Mean % All Deaths",
  x = "Event Date",
  title = "% of Covid Deaths That Were Hospitalized",
  subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data"
)

# Select county trends in cases

nowDat <- flDat[eDat >= (max(eDat) - 14), .N, by = c("County", "eDat")]
widDat <- spread(nowDat, eDat, N)
widDat <- widDat[order(-widDat[, 13]), ]
widDat <- widDat[1:8, ]
tcnt <- list(widDat$County)
plDat <- nowDat[nowDat$County %in% widDat$County, ]
plDat[, County := as.factor(County)]

p90 <-
  ggplot(data = plDat, aes(
    x = eDat,
    y = N,
    group = County,
    colour = County
  )) +
  geom_line() +
  labs(title = "Cases From FL DOH In Select Counties",
       y = "Cases",
       x = "Event Date")

yest2 <- flDat[eDat == max(eDat), ]

mage <- flDat[, .(.N, median(Age, na.rm = T)), by = eDat]
mage[order(eDat), ]
hage<-flDat[Hospitalized=="YES",median(Age,na.rm = T),by=eDat]
mage<-merge(mage,hage,by="eDat")

mage <- mage[eDat > "2020-02-29", ]



mz <- ggplot(mage, aes(x = eDat))
mz <-
  mz + geom_line(aes(x = eDat, y = V2 , colour = "Median Age Covid Cases (left axis)"))
mz<- mz + geom_line(aes(x = eDat, y = V1 , colour = "Median Age Covid Hospitalizations (left axis)"))

#   # adding the relative humidity data, transformed to match roughly the range of the temperature
mz <-
  mz + geom_line(aes(x = eDat, y = N /180, colour = "Daily Cases (right axis)")) +
  theme_bw()
#   # now adding the secondary axis, following the example in the help file ?scale_y_continuous
#   # and, very important, reverting the above transformation
mz <-
  mz + scale_y_continuous(sec.axis = sec_axis( ~ . * 180, name = "Daily Cases"))
#
#   # modifying colours and theme options
mz <- mz + scale_colour_manual(values = c("blue", "red","black"))
mz <- mz + labs(
  y = "Age",
  x = "Event Date",
  colour = "Florida",
  subtitle = "Data: https://open-fdoh.hub.arcgis.com/datasets/florida-covid19-case-line-data/data"
)
mz <- mz + theme(legend.position = c(0.35, 0.4))

cage <- flDat[, .(.N, sum(Age > 64, na.rm = T)), by = eDat]
cage[, pctGE65 := V2 / N]
cage[order(eDat), ]

#
dage <- flDat[Died == "Yes", .N, by = eDat]
dage <- merge(dage, cage, by = "eDat")
dage[, pctDied := N.x / N.y]

# Look at Covid cases and deaths by gender
male <- flDat[Gender == "Male", .N, by = eDat]

dage <- merge(male, dage, by = "eDat")
dage <- dage[order(eDat), ]
dage[, pctMale := N / N.y]
dage2<-flDat[Died=="Yes" & Gender=="Male",.N,by=eDat]
colnames(dage2)<-c("eDat","mDead")
dage2<-merge(dage2,dage,by="eDat")
dage2[,deathPctMale:=mDead/N.x]
# #

# #
jnk <- flDat[eDat > Sys.Date() - 7, median(Age, na.rm = T), by = County]
# jnk<-yest2[,.N,by=County]
#
colnames(jnk) <- c("Admin2", "Cases")
jnk[Admin2 == "Dade", Admin2 := "Miami-Dade"]
jnk <- merge(jnk, JHcounty, by = "Admin2", all.y = F)
jnk[, id := as.character(FIPS)]
# #
#   jnk[,id:=as.character(id)]
jnk <- merge(jnk, county_map, by = "id", all.y = F)
jnk <- jnk[Province_State == "Florida", ]
jnk[, x := (max(long) + min(long)) / 2, by = FIPS]
jnk[, y := (max(lat) + min(lat)) / 2, by = FIPS]


# Map median age of recent cases by county
library(urbnthemes)

qjnk <- jnk %>%
  ggplot(mapping = aes(long, lat, group = group, fill = Cases)) +
  geom_polygon(color = "black", size = .25) +
  scale_fill_gradient2(labels = scales::comma,
                       guide = guide_colorbar(title.position = "top")) +
  geom_text(data = jnk,
            aes(
              x = x,
              y = y,
              label = round(Cases, 0),
              group = NULL
            ),
            size = 3) +
  # coord_map(projection = "albers", lat0 = 25, lat1 = 31) +
  theme(legend.title = element_text(),
        legend.key.width = unit(.5, "in")) +
  labs(fill = "Median Age",
       title = "Median Age of Covid Cases From Last 7 Days By County",
       subtitle = "Blank Counties=No Data") +
  theme_urbn_map()

dage <- dage[eDat > "2020-02-29", ]

pz <- ggplot(dage, aes(x = eDat))
pz <-
  pz + geom_line(aes(
    x = eDat,
    y = 100 * pctGE65 ,
    colour = "% Cases >= 65 yrs old"
  ))


pz <-
  pz + geom_line(aes(
    x = eDat,
    y = 100 * pctDied,
    colour = "% All Deaths/All Cases"
  )) +
  theme_bw()  +
  scale_y_continuous(labels = scales::comma_format())
#   # now adding the secondary axis, following the example in the help file ?scale_y_continuous
#   # and, very important, reverting the above transformation
pz <- pz + scale_colour_manual(values = c("blue", "red"))
pz <- pz + labs(y = "%",
                x = "Event Date",
                colour = "Florida")
pz <- pz + theme(legend.position = c(0.2, 0.9))

#------------------Section on Gompertz & Network equation fit to FL data --------------------------

library(minpack.lm)

gomEq2 <- function(a,b,c) {
  as.numeric(a)*exp(-exp(-as.numeric(b)*(seq(1:200)-as.numeric(c))))
}

# Use case date because it deaths probably occurred after Event Date (first contact)
gomDat<-flDat[Died=="Yes",.N,by=eDat]
gomDat<-gomDat[order(eDat),]
gomDat[,cumDeath:=cumsum(N)]

fstDate<-gomDat[cumDeath>9,min(eDat)]

u1t <- gomDat[eDat >= fstDate, ]
data1 <- data.frame(seq(1:nrow(u1t)),u1t$cumDeath)
colnames(data1) <- c("d", "cd")

Gompfit <- function(d1,u1) {  
  #fit data to Gompertz model form 2
  modA <-
    nlsLM(cd ~ a * exp(-exp(-b * (d - Ti))),
          data = d1,
          start = list(
            a = max(u1$cumDeath,na.rm = T),
            b = 0.05,
            Ti = 20
          ))
  summary(modA)
}
  ob <- Gompfit(data1,u1t)
  
      #fit network graph to FL daily death data
  u1t[,x:=1:nrow(u1t)]
  colnames(u1t)<-c("cDat","deathIncrease","cumDeath","x")

  modN <- nlsLM(deathIncrease ~ (K∗(x) ^ q)∗exp(−(x) / z),data = u1t, start = list(K = 200,q = 0.9, z = 8))
  
  netTotal<-sum(predict(modN,newdata=data.frame(x=seq(1,300))))
  
  library(easynls)
  #fit data to the Gompertz model form 1
  mod10<-nlsfit(data1, model=10, start = c(a=3400,b=11,c=.1))
  mod10


  # Compare FL DOH model to covidTracking.com data model fit
  # urlfile<- "https://covidtracking.com/api/v1/states/daily.csv"
  # stLevel<-data.table(read.csv(url(urlfile)))
  # stLevel[,Date:=as.Date(as.character(date),format="%Y%m%d")]
  # stLevel<-stLevel[state=="FL",]
  # stLevel<-stLevel[order(Date),]
  # fdatCT<-stLevel[,c("Date","deathIncrease")]
  # fdatCT[,cumDeath:=cumsum(deathIncrease)]
  # u1t <- fdatCT[cumDeath>9, ]
  # data1 <- data.frame(seq(1:nrow(u1t)), u1t$cumDeath)
  # colnames(data1) <- c("d", "cd")
  # 
  # obCT<-Gompfit(data1,u1t)

  #fit network graph to FL daily death datatail

# Adding a SIR model   
  # From https://rpubs.com/choisy/sir and https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4552173/

library(deSolve) # using the "ode" function
  
covidSIR<-flDat[Died=="Yes",.N,by=eDat]
covidSIR<-covidSIR[order(eDat)]
covCum<-data.frame(cbind(seq(1:nrow(covidSIR)),cumsum(covidSIR$N)))
colnames(covCum)<-c("days","cumDeath")  
  
  
sir_1 <- function(beta, gamma, f, S0, I0, D0, R0, times) {
  require(deSolve) # for the "ode" function
  
  # the differential equations:
  sir_equations <- function(time, variables, parameters) {
    with(as.list(c(variables, parameters)), {
      dS <- -beta * I * S
      dI <-  beta * I * S - gamma * I
      dD <-  gamma * f * I
      dR <-  (1 - f) * gamma * I
      return(list(c(dS, dI, dD, dR)))
    })
  }
  
  # the parameters values:
  parameters_values <- c(beta  = beta, gamma = gamma, f=f)
  
  # the initial values of variables:
  initial_values <- c(S = S0, I = I0, D=D0, R = R0)
  
  # solving
  out <- ode(initial_values, times, sir_equations, parameters_values)
  
  # returning the output:
  as.data.frame(out)
}


startRow <- 40
popSize <- 4e6

ss <- function(beta, gamma, f, data = covCum[startRow:nrow(covCum),], N = popSize) {
  I0 <- data$cumDeath[1]/0.0026
  D0<- data$cumDeath[1]
  times <- data$days
  predictions <- sir_1(beta = beta, gamma = gamma, f = f,  # parameters
                       S0 = N - I0 - D0, I0 = I0, D0 = D0, R0 = 0, # variables' intial values
                       times = times)                # time points
  sum((predictions$D[-1] - data$cumDeath[-1])^2)
}

# xx<-sir_1(0.0025,.1,0.0026,popSize,1,0,0,time_values)
ss2 <- function(x) {
  ss(beta = x[1], gamma = x[2], f = x[3])
}


  # beta_val <- seq(from = 0.000026, to = 0.00000026, le = 100)
  # ss_val <- sapply(beta_val, ss, beta = 1.08, gamma = 0.5)

starting_param_val <- c(.0000003,0.5,.00005)
ss_optim <- optim(starting_param_val, ss2)


for (i in 1:10) {
starting_param_val <- c(ss_optim$par[1],ss_optim$par[2],ss_optim$par[3])
ss_optim <- optim(starting_param_val, ss2)
}

InitInf<-covCum[startRow,]$cumDeath/0.0026
do<-covCum[startRow,]$cumDeath

xx<-sir_1(ss_optim$par[1],ss_optim$par[2],ss_optim$par[3],
          popSize-InitInf - do,
          InitInf,
          do,
          0,
          covCum[startRow:nrow(covCum),]$days)

plot(xx$time,xx$D)
lines(covCum[startRow:nrow(covCum),]$days,covCum[startRow:nrow(covCum),]$cumDeath,col='red')

xxP<-sir_1(ss_optim$par[1],ss_optim$par[2],ss_optim$par[3],
          popSize-InitInf - do,
          InitInf,
          do,
          0,
          seq(startRow,300,1))

SIRdeaths<-max(xxP$D)

#-------------------------------------------------------------------------------------------------



```


Updated on `r Sys.Date()`

## R Code

All code used to produce this site can be found on [Github](https://github.com/whelanh/WorldValueSurveyRCode/blob/master/FLcovid.rmd)

## Median Age of Covid Cases by Event Date

```{r echo=FALSE}
mz
```

## Median Age of Cases From Last 7 Days By County

```{r}
qjnk
```

## % of Cases Aged >= 65 Years Old vs Case Death Rate

```{r}
pz
```

## ED-only and Hospitalization Demographics

```{r echo=FALSE,fig.width=10, fig.height=8, fig.fullwidth=TRUE}
xxcht

xxxcht
```

## Hospitalization and ED visit Trends

The two charts below show (1) that almost all Covid cases that are hospitalized also were identified as having visited the ED, and (2) the share of ED Covid visits that were NOT identified as having been hospitalized has been increasing.

```{r, warning=F}
edHospShare
edHospShare2
```

## Age Demographics Of FL Covid Deaths

```{r echo=FALSE,fig.width=10, fig.height=8, fig.fullwidth=TRUE,warning=F}
ddcht

ddcht2
```

## Hospitalization Status of FL Covid Deaths

```{r echo=FALSE,fig.width=10, fig.height=8, fig.fullwidth=TRUE,warning=FALSE}
dddcht

dddcht2
```

## Covid Long Term Care Deaths

This data is hand compiled by Twitter users @kerpen and @nosmhnmh in their excellent [spreadsheet](https://docs.google.com/spreadsheets/d/1ETm51GayRjlnoaRVtUOWfkolEeAQZ-zPhXkCbVe4_ik/edit#gid=435667374) covering LTC deaths in the US. Their Florida data is sourced from the FL DOH.

As of `r max(ltcDat2$date)`, **the cumulative total of long term care Covid deaths comprises `r percent(cumLTCdeath,digits=1)` of the cumulative number of all FL Covid deaths.**

```{r echo=FALSE,fig.width=10, fig.height=8, fig.fullwidth=TRUE,warning=FALSE}
suppressWarnings(ltc)
```

## Covid: Place Of Death vs. US averages

```{r, figures-side, fig.show="hold", out.width="90%"}
par(mar = c(4, 4, .1, .1))
placeCht1
placeCht2
```

## Covid Death and Cases Percentages By Gender

Most recent 4 weeks yield **erratic values** for percentage of death because of the small number of deaths. 

```{r}
dage2<-dage2[eDat>"2020-03-01",]

plot(dage2$eDat,rollmean(100*dage2$deathPctMale,7,na.pad = T,align = "right"),type='l',ylab = "% Male",xlab="Event Date",
     main = "Red line = 7 day Avg. % Of Cases", sub = "Black line = 7 day Avg. % of Deaths")
 lines(dage2$eDat,rollmean(100*dage2$pctMale,7,na.pad = T,align = "right"),col='red')
 abline(h=50)
```


## Case Trend In Select Counties

```{r}
p90
```

## Distribution of Death by Age: From All Causes vs. Covid Deaths Alone

The 2019 and 2020 All Causes age distribution is from [Public Health data](http://www.flpublichealth.com/VSprov/rdPage.aspx?rdReport=ProvReports&radReport=T2&drpYear=2020). The 2020 All Cause data is only through March -- so the 2020 All Cause percent distribution does not fully reflect the impact of Covid deaths this year.  Covid deaths are up to date to the current date.

```{r echo=FALSE,fig.width=14, fig.height=8, fig.fullwidth=TRUE,warning=FALSE}
allCcht2

gdeath<-round(ob$parameters[1],0)
ndeath<- round(netTotal,0)
currdeath<-round(max(u1t$cumDeath),0)
library(formattable)
```

## Gompertz & Network Graph fits to FL Covid Death data

Both Gompertz and Network graph equations have been proposed as good functional fits to model deaths as an infection spreads within a system (like the state of Florida). If you are interested in the topic, I have a [separate site](https://rpubs.com/whelanh/CovidGompertz) that uses these to look at US Covid death data.

I am not aware of good FL data that separately dates infection versus death.  FL's Event Date is date of earliest contact and is unlikely to be the death date.  I use Case Date as a proxy for actual date of death. Both equations provide good fits to FL cumulative death (for Gompertz) and daily deaths (for Network Graph).

The Gompertz equation projects total deaths of **`r comma(gdeath,digits=0)`**.  The Network Graph equation projects total deaths of **`r comma(ndeath,digits=0)`** deaths.  These both compare to currently reported total deaths of **`r comma(currdeath,digits=0)`**. This would imply that FL has already experienced approximately `r percent(currdeath/ndeath,digits = 0)` of total projected deaths. The chart below summarizes the Gompertz equation fit to FL's cumulative Covid death curve:

```{r}
nlsplot(data1,model = 10,start = c(a = 3400, b = 11, c = .1),xlab = "Days since Cum Deaths>=10, Gompertz Eq. ",ylab = "FL Cum Covid Deaths",position = 1)
u1tRows<-nrow(u1t)

gomEq <- function(t) {
  as.numeric(unlist(mod10)[2])*exp(-as.numeric(unlist(mod10)[3])*exp(-as.numeric(unlist(mod10)[4])*t))
}

forc<- gomEq(c((u1tRows+2):(u1tRows+6)))-gomEq(c((u1tRows+1):(u1tRows+5)))
```

Both equations "fit" to FL's daily deaths is shown below.  Although the actual daily death data fluctuates quite a bit, the "smoothed" projected daily deaths using the Gompertz equation for the next 5 days is: `r round(forc,0)`.  **Note: these daily numbers should be compared to the FL DOH data by Event Date**, NOT covidtracking.com which does not assign them to their correct dates.

```{r}
dlyForecast<-gomEq(seq(2,200))-gomEq(seq(1,199))
plot(seq(2,(nrow(u1t)+1)),u1t$deathIncrease,xlab="Days Since Cum Deaths>=10",ylab="Daily Covid Deaths",main="Red line = Gompertz Estimate", sub="Blue line = Network Graph Equation")
lines(seq(2:(length(dlyForecast)+1)),dlyForecast,col='red')
lines(u1t$x,predict(modN),col='blue')

```


## Simple Extrapolation of Declining Growth Rate of Cumulative Covid Deaths

Michael Levitt (@MLevitt_NP2013) is the first one to observe that the growth rate of Covid cumulative deaths declines linearly in nearly every region infected with Covid. That has been the case for Florida as shown below.  The chart also makes clear that deaths will be added to the last 4 days as future records are processed by the Florida DOH as those dates fall significantly below the linear relationship. If the relationship continues to be stable, extrapolating the red line indicates there will be approsimately `r comma(additionalDeaths,digits=0)` additional Covid deaths.

```{r warning=F}
mlevitt
```

## Model forecasts for FL Covid Deaths

The [CDC](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/forecasting-us.html#state-forecasts) periodically summarizes approximately 20 model forecasts for FL Covid deaths. These forecasts are higher than the Gompertz/Network "forecasts" above. It may be that the Gompertz/Network equations are better viewed as "after the fact" mathematical descriptors than forecasts.

```{r warning=F,echo=FALSE}
kable(cdcForc,table.attr = "style='width:75%;'")
```

```{r warning=F,echo=FALSE, results='asis'}
# print(dfSummary(cdcForc[,3:6], plain.ascii = FALSE, style = "grid",graph.magnif = 0.75, missing.col=F,valid.col = FALSE),method = 'render')
```

## Fitting A SIR Model To FL Covid Deaths

A standard model used in epidimeology is the SIR model. More about the form of SIR model I use can be found at this [link](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4552173/). The only difference between the formulas I use and those described at the link is I do not include a re-infection term. I derived the SIR parameters using deaths (not cases). Working with these models it seems to me they have a weakness fitting both the early part and the latter part of the Covid cumulative death curve. The chart below shows the SIR forecasted daily death line versus FL DOH reported daily deaths. The SIR forecast for ultimate total FL deaths is `r comma(SIRdeaths,digits=0)`.  This is in-line with the other models listed above.  

```{r warning=F}
plot(covCum$cumDeath[40:nrow(covCum)]-lag(covCum$cumDeath[40:nrow(covCum)],1),ylab = "Daily Covid Deaths",
     xlab = "Days Since The 40th Day Of Deaths",main = "FL Daily Deaths vs. SIR fit (red line)")
lines(xxP$D-lag(xxP$D,1),col='red')

```

## Florida Covid Testing Volume

```{r warning=F}
test3
```

## Florida Hospitalization/Case Ratio, Case Fatality Ratio and Death/Hospitalization By Month

Values for the latest month are effected by increases in testing volume which can increase the number of cases (the denominator), and by lags (as much as 21 days) between case identification and death (which can suppress the numerator).

```{r}
kable(ttt3[1:(nrow(ttt3)-1),c(1,3:7)],caption="Hospitalization/Case Ratio By Month Number",table.attr = "style='width:75%;'")
kable(ttt2[1:(nrow(ttt2)-1),c(1,3:7)],caption="CFR By Month Number",table.attr = "style='width:75%;'")
kable(ttt4[1:(nrow(ttt4)-1),c(1,3:7)],caption="Covid Death/Hospitalization Ratio By Month Number",table.attr = "style='width:75%;'")

kable(tttc,caption = "Total Deaths and Cases By Month (based on Event Date)",table.attr = "style='width:50%;'")
```


## Statistically Derived Lag Between Daily Cases and Daily Deaths

Using the FL DOH caseline data, I look at the autocorrelation between 7-day mean daily cases and 7-day mean daily deaths. For this exercise I use **Case Date** because I am trying to answer the question: how does the most recent report on cases line up with future increases in reported deaths? I am not concerned with Event Date when these actually may have occurred in the past. Seven day smoothing is used to eliminate the strong day of the week effect because of subdued reporting on weekends.

The most powerful lag is `r bestLag` days between **all** reported cases and subsequent deaths. **However not all cases are likely to produce deaths.**  **Cases aged over `r ageCutoff` generate 90% of all FL Covid deaths** (this number has been stable pre and post May 20). When we examine the best lag for these relevant cases, the best lag is `r bestLagNew` days.   

```{r}
l3
```

The chart below plots 7-day mean **relevant cases** (aged `r ageCutoff` years older) plotted ahead in time by its best lag versus 7-day mean Covid deaths by Case Date.  Even relevant cases seem to be diverging from deaths.

```{r fig.width=10, fig.height=8, fig.fullwidth=TRUE,warning=FALSE}

lagz
```

## FL Covid Deaths As A Percentage Of All FL Deaths In 2020

CDC data on FL lags the FL DOH data (which is where the CDC gets their data), but the weekly percentage of All FL Deaths due to Covid should be accurate unless Covid deaths are reported with a greater/lesser lag than other deaths.  The last weekly CDC value indicates **Covid deaths now comprise `r percent(lastCDCpct,digits=1)` of all FL deaths, down from a maximum weekly value of `r percent(max(cdcDat$pctCov,na.rm=T),digits=1)`**.

```{r}
suppressWarnings(ny3)
```

## FL Deaths From All Causes vs. Prior Years

The chart below compares 2020 to prior years. Deaths for prior years have been adjusted upwards to account for population growth. Through week `r lastWkNum`, total deaths were `r comma(excessDeaths,digits=0)` above the mean of the 4 prior years.

```{r fig.width=10, fig.height=8, fig.fullwidth=TRUE,warning=FALSE}

allDthPlot
```

## Google Mobility Data FL compared to NY and TX

Tracking deviation from "normal" baseline activity within recreation, workplace, and residential (staying near home).

```{r, warning=FALSE}
g1
g2
g3
```

## Florida Provisional CDC Cause of Death Data

Data for this table can be found [here](https://data.cdc.gov/NCHS/Weekly-Counts-of-Deaths-by-State-and-Select-Causes/muzy-jte6). It should be interpreted carefully as it is provisional. **It also only includes selected causes of death, so numbers do not sum to the natural cause total.** **It also only compares to one year (2018 was a much worse flu year) and is not adjusted for population growth (approx. 1.1% p.a.).** This table is through `r causeDeath[(nrow(causeDeath)-1),week_ending_date]` (I don't use the most recent reported week because it suffers from lagged reporting). Most of the difference between "Covid multiple cause of death" and "Covid underlying cause" is counted in "influenza and pneumonia." The large increase in "symptoms signs and abnormal" includes a [large group of potential causes](https://en.wikipedia.org/wiki/ICD-10_Chapter_XVIII:_Symptoms,_signs_and_abnormal_clinical_and_laboratory_findings#(R50%E2%80%93R69)_General_symptoms_and_signs). It is an interesting "unknown" category that speculatively could include deaths related to alzheimers/dementia, undercounted Covid deaths and deaths due to lockdown-related reluctance to seek care for other diseases.

```{r}
cause$`2019 partial`<-comma(cause$`2019 partial`,digits = 0)
cause$`2020 partial`<-comma(cause$`2020 partial`,digits = 0)
cause$`Difference`<-comma(cause$Difference, digits = 0)
cause$`Pct Change`<-percent(cause$`Pct Change`,digits=1)
kable(cause,caption="CDC Partial Cause Of Death Data",table.attr = "style='width:70%;'")
```

## March - June All Deaths vs. Covid Deaths

Florida publishes preliminary total deaths from all causes by month at this [link](http://www.flpublichealth.com/VSprov/rdPage.aspx?rdReport=ProvReports&radReport=T2&drpYear=2020). We can compare the total of all deaths from March through June in 2020 to those from prior years (June data is not yet complete).  The table below subtracts the average of the population growth adjusted March - June deaths from a 2018-2019 baseline (I assume population has grown by 1.2% by year) from 2020's March - June deaths. This is a gross "Excess Death" number.  The Covid Deaths are from the New York Times [database](https://github.com/nytimes/covid-19-data) through June 30.  The last column of the table subtracts the Covid deaths from the Excess Deaths to estimate Excess Deaths not attributable to Covid.

Totals for the state are shown on the first row.

```{r excessDeath}
kable(ansTab)
```

